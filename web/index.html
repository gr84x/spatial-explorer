<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spatial Explorer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleblock">
        <h1>Spatial Explorer</h1>
        <p class="subtitle">Visualize spatial biology data</p>
        <p id="datasetLabel" class="dataset-info" style="display:none;"></p>
      </div>

      <div class="badge" title="Mock dataset generated in-browser">
        <span class="dot"></span>
        <span id="datasetBadgeText"><strong style="color:var(--color-text);font-weight:600">12000</strong> cells • 7 types • realistic markers</span>
      </div>
    </header>

    <div class="grid">
      <div class="panel viz" aria-label="Spatial plot">
        <div class="vizbar">
          <div class="search-section">
            <div class="field" title="Type a gene symbol to color cells by expression">
              <label for="gene">Gene</label>
              <input id="gene" list="genes" inputmode="latin" autocomplete="off" spellcheck="false" placeholder="Search gene (EPCAM, CD3E, CD19…)" />
              <datalist id="genes"></datalist>
              <button class="help-btn" id="geneHelp" type="button" title="Show gene help" aria-label="Gene search help">?</button>
            </div>
            <div class="hint hint--collapsible" id="geneHint">Tip: try <strong>EPCAM</strong>, <strong>CD3E</strong>, <strong>CD19</strong>, <strong>LST1</strong>, <strong>PECAM1</strong></div>
          </div>

          <div class="toolbar">
            <div class="toolbar-group">
              <button class="btn btn--primary" id="load" title="Upload a CSV/TSV file">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                <span>Upload</span>
              </button>
              <button class="btn" id="reset" title="Reset view">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                <span class="btn-label">Reset</span>
              </button>
            </div>

            <div class="toolbar-group toolbar-group--zoom">
              <button class="btn btn--icon" id="zout" title="Zoom out" aria-label="Zoom out">−</button>
              <button class="btn btn--icon" id="zin" title="Zoom in" aria-label="Zoom in">+</button>
            </div>

            <div class="toolbar-group">
              <div class="dropdown" id="exportDropdown">
                <button class="btn" id="exportToggle" type="button" aria-haspopup="true" aria-expanded="false">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15M7 10l5 5 5-5M12 15V3"/></svg>
                  <span class="btn-label">Export</span>
                  <svg class="dropdown-arrow" width="10" height="10" fill="currentColor" viewBox="0 0 16 16"><path d="M8 11L3 6h10z"/></svg>
                </button>
                <div class="dropdown-menu" id="exportMenu" role="menu">
                  <button class="dropdown-item" id="exportPng" role="menuitem">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    Export PNG
                  </button>
                  <button class="dropdown-item" id="exportSvg" role="menuitem">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M14 2v6h6"/></svg>
                    Export SVG
                  </button>
                  <div class="dropdown-divider"></div>
                  <div class="dropdown-section">
                    <label class="dropdown-label">
                      Resolution
                      <select class="select-sm" id="exportScale">
                        <option value="1">1x</option>
                        <option value="2" selected>2x</option>
                        <option value="4">4x</option>
                      </select>
                    </label>
                    <label class="dropdown-label" title="Calibration: microns per pixel">
                      µm/px
                      <input class="input-sm" id="umPerPx" type="number" min="0" step="0.001" value="200" inputmode="decimal" />
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="toolbar-group toolbar-group--end">
              <button class="btn btn--icon" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">
                <svg class="theme-icon theme-icon--sun" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><circle cx="8" cy="8" r="3.5"/><path d="M8 1v2M8 13v2M15 8h-2M3 8H1M12.95 3.05l-1.41 1.41M4.46 11.54l-1.41 1.41M12.95 12.95l-1.41-1.41M4.46 4.46L3.05 3.05"/></svg>
                <svg class="theme-icon theme-icon--moon" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>
              </button>
              <button class="btn btn--icon" id="feedbackBtn" title="Send feedback" aria-label="Send feedback">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              </button>
            </div>
          </div>

          <input id="file" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values" style="display:none" />
        </div>

        <div class="canvasWrap">
          <div id="welcome" class="emptyState" aria-label="Empty state">
            <div class="emptyState-content">
              <svg class="emptyState-icon" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
              </svg>
              <h2 class="emptyState-title">Drop a file or click Upload</h2>
              <p class="emptyState-text">CSV/TSV with <strong>cell_id</strong>, <strong>x</strong>, <strong>y</strong> columns</p>
              <div class="emptyState-actions">
                <button class="btn btn--primary btn--large" id="welcomeUpload">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                  Upload Dataset
                </button>
              </div>
              <button class="emptyState-dismiss" id="welcomeDismiss" title="View demo data">
                <span>or continue with demo</span>
              </button>
            </div>
          </div>

          <canvas id="gl" aria-hidden="true"></canvas>
          <canvas id="c" aria-label="Tissue scatterplot" role="img"></canvas>
          <div class="tooltip" id="tip"></div>

          <div id="drop" class="dropOverlay">
            <div style="text-align:center;max-width:46ch;">
              <div style="font-weight:650;margin-bottom:6px;">Drop CSV/TSV to load data</div>
              <div class="note">Required columns: <strong>cell_id</strong>, <strong>x</strong>, <strong>y</strong>. Optional: <strong>cell_type</strong>. Remaining columns are treated as gene expression.</div>
            </div>
          </div>
        </div>
      </div>

      <aside class="panel side" aria-label="Controls and details">
        <div class="card">
          <div class="sectionTitle">Cell types</div>
          <div class="legend" id="legend"></div>
          <div class="statusLine" id="visStatus"></div>
        </div>

        <div class="card" id="gateCard">
          <div class="sectionTitle">Phenotype gate</div>
          <div class="note" style="margin-bottom:10px">
            Build boolean queries like <strong>CD8A+</strong> AND <strong>CD3E+</strong> AND <strong>NOT CD4+</strong>. Matching cells are highlighted on the plot.
          </div>

          <div id="gateRows" style="display:flex;flex-direction:column;gap:8px;"></div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
            <button class="btn" id="gateAdd">Add condition</button>
            <button class="btn" id="gateClear" title="Remove all conditions">Clear</button>
            <label class="check" style="margin-left:auto;font-size:12px;color:var(--color-muted);" title="Toggle gate highlight">
              <input id="gateEnabled" type="checkbox" checked />
              Highlight gate
            </label>
          </div>

          <div style="margin-top:10px">
            <div class="k" style="margin-bottom:6px">Expression</div>
            <input id="gateExpr" class="input-pill" spellcheck="false" autocomplete="off" placeholder="A AND (B OR NOT C)" />
            <div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap;">
              <label class="check" style="font-size:12px;color:var(--color-muted);">
                <input id="gateAdvanced" type="checkbox" />
                Advanced expression (edit manually)
              </label>
              <div class="hint" id="gateStatus" style="margin-left:auto"></div>
            </div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
            <button class="btn" id="gateCopy" title="Copy gate JSON to clipboard">Copy gate JSON</button>
            <button class="btn" id="gatePaste" title="Paste/import gate JSON">Paste gate JSON</button>
          </div>
          <div class="note" style="margin-top:8px">Operands are condition labels: A, B, C… Operators: AND, OR, NOT, parentheses.</div>
        </div>

        <div class="card" id="details">
          <div class="sectionTitle">Selected cell</div>
          <div class="note" id="emptySel">Click a cell to inspect its expression profile. Use gene search to paint expression across the tissue.</div>
          <div id="sel" style="display:none">
            <div class="kv">
              <div class="k">Cell ID</div><div class="v" id="selId"></div>
              <div class="k">Type</div><div class="v" id="selType"></div>
              <div class="k">Coordinates</div><div class="v" id="selXY"></div>
              <div class="k">Neighborhood</div><div class="v" id="selZone"></div>
            </div>
            <div class="bars" id="bars"></div>
            <div class="note" style="margin-top:10px">
              Values are synthetic “log-normalized” expression (higher ≈ more transcripts). Marker genes are enriched by cell type (e.g., CD3D/E in T cells, COL1A1 in fibroblasts).
            </div>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">How to use</div>
          <div class="note">
            • Pan: drag • Zoom: mouse wheel / trackpad • Tap: select cell<br/>
            • Filters: hide/show cell types • Gene query: colors cells by expression
          </div>
        </div>
      </aside>
    </div>

    <footer class="siteFooter" aria-label="Brand footer">
      <div class="footer-content">
        <span class="footer-text">A</span>
        <a href="https://gr84x.com" target="_blank" rel="noopener noreferrer" class="footer-brand">
          <span class="footer-brand-name">gr84x</span>
        </a>
        <span class="footer-text">experience</span>
      </div>
    </footer>
  </div>

  <!-- Feedback modal -->
  <div id="feedbackModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle" style="display:none">
    <div class="modal__backdrop" data-close="1"></div>
    <div class="modal__panel" role="document">
      <div class="modal__header">
        <div>
          <div id="feedbackTitle" class="modal__title">Send feedback</div>
          <div class="modal__subtitle">This opens your email client (mailto).</div>
        </div>
        <button class="btn" id="feedbackClose" title="Close" aria-label="Close">✕</button>
      </div>

      <div class="modal__body">
        <label class="modal__label" for="feedbackName">Name</label>
        <input class="modal__input" id="feedbackName" type="text" autocomplete="name" placeholder="Optional" />

        <label class="modal__label" for="feedbackEmail">Email</label>
        <input class="modal__input" id="feedbackEmail" type="email" autocomplete="email" inputmode="email" placeholder="Optional" />

        <label class="modal__label" for="feedbackMsg">Message</label>
        <textarea class="modal__textarea" id="feedbackMsg" rows="6" placeholder="What should we improve?"></textarea>

        <div class="modal__actions">
          <button class="btn btn--primary" id="feedbackSend">Open email</button>
          <button class="btn" id="feedbackCopy" title="Copy a mailto link (fallback)">Copy link</button>
        </div>

        <div class="note" id="feedbackStatus" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
