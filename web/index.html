<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spatial Transcriptomics Explorer (Demo)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleblock">
        <h1>
          Spatial Transcriptomics Explorer
          <span id="datasetLabel" style="color:var(--color-muted);font-weight:500">(synthetic demo)</span>
        </h1>
        <p>
          Spatial transcriptomics measures gene expression while keeping each cell’s location in the tissue.
          This mini explorer mimics what you’d do on a real section: map cell types, query marker genes, and inspect single-cell profiles.
        </p>
      </div>

      <div class="badge" title="Mock dataset generated in-browser">
        <span class="dot"></span>
        <span id="datasetBadgeText"><strong style="color:var(--color-text);font-weight:600">12000</strong> cells • 7 types • realistic markers</span>
      </div>
    </header>

    <div class="grid">
      <div class="panel viz" aria-label="Spatial plot">
        <div class="vizbar">
          <div class="left">
            <div class="field" title="Type a gene symbol to color cells by expression (e.g., EPCAM, CD3E, COL1A1)">
              <label for="gene">Gene</label>
              <input id="gene" list="genes" inputmode="latin" autocomplete="off" spellcheck="false" placeholder="Search gene (EPCAM, CD3E, CD19, LST1, COL1A1…)" />
              <datalist id="genes"></datalist>
            </div>
            <div class="hint" id="geneHint">Tip: try <strong>EPCAM</strong> (tumor), <strong>CD3E</strong> (T), <strong>CD19</strong> (B), <strong>LST1</strong> (myeloid), <strong>PECAM1</strong> (endo).</div>
          </div>

          <div class="controls">
            <button class="btn btn--primary" id="load" title="Load a CSV/TSV file (or drag & drop onto the plot)">Load CSV/TSV</button>
            <input id="file" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values" style="display:none" />
            <button class="btn" id="reset">Reset view</button>
            <button class="btn" id="zin" title="Zoom in">+</button>
            <button class="btn" id="zout" title="Zoom out">−</button>

            <label class="formRow" title="Calibration: microns per source pixel (x/y units). Used for the on-canvas scale bar.">
              µm/px
              <input class="input-sm" id="umPerPx" type="number" min="0" step="0.001" value="200" inputmode="decimal" />
            </label>

            <label class="formRow">
              Export
              <select class="select-sm" id="exportScale" title="Export resolution multiplier">
                <option value="1">1x</option>
                <option value="2" selected>2x</option>
                <option value="4">4x</option>
              </select>
            </label>

            <button class="btn" id="exportPng" title="Download the current view as a PNG">Export PNG</button>
            <button class="btn" id="exportSvg" title="Download the current view as an SVG (vector)">Export SVG</button>
          </div>
        </div>

        <div class="canvasWrap">
          <canvas id="gl" aria-hidden="true"></canvas>
          <canvas id="c" aria-label="Tissue scatterplot" role="img"></canvas>
          <div class="tooltip" id="tip"></div>

          <div id="drop" class="dropOverlay">
            <div style="text-align:center;max-width:46ch;">
              <div style="font-weight:650;margin-bottom:6px;">Drop CSV/TSV to load data</div>
              <div class="note">Required columns: <strong>cell_id</strong>, <strong>x</strong>, <strong>y</strong>. Optional: <strong>cell_type</strong>. Remaining columns are treated as gene expression.</div>
            </div>
          </div>
        </div>
      </div>

      <aside class="panel side" aria-label="Controls and details">
        <div class="card">
          <div class="sectionTitle">Cell types</div>
          <div class="legend" id="legend"></div>
          <div class="statusLine" id="visStatus"></div>
        </div>

        <div class="card" id="gateCard">
          <div class="sectionTitle">Phenotype gate</div>
          <div class="note" style="margin-bottom:10px">
            Build boolean queries like <strong>CD8A+</strong> AND <strong>CD3E+</strong> AND <strong>NOT CD4+</strong>. Matching cells are highlighted on the plot.
          </div>

          <div id="gateRows" style="display:flex;flex-direction:column;gap:8px;"></div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
            <button class="btn" id="gateAdd">Add condition</button>
            <button class="btn" id="gateClear" title="Remove all conditions">Clear</button>
            <label class="check" style="margin-left:auto;font-size:12px;color:var(--color-muted);" title="Toggle gate highlight">
              <input id="gateEnabled" type="checkbox" checked />
              Highlight gate
            </label>
          </div>

          <div style="margin-top:10px">
            <div class="k" style="margin-bottom:6px">Expression</div>
            <input id="gateExpr" spellcheck="false" autocomplete="off" placeholder="A AND (B OR NOT C)" style="width:100%;background:rgba(10,10,10,.55);border:1px solid var(--color-border);border-radius:14px;padding:10px 10px;color:var(--color-text);font-size:12px;outline:none" />
            <div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap;">
              <label class="check" style="font-size:12px;color:var(--color-muted);">
                <input id="gateAdvanced" type="checkbox" />
                Advanced expression (edit manually)
              </label>
              <div class="hint" id="gateStatus" style="margin-left:auto"></div>
            </div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
            <button class="btn" id="gateCopy" title="Copy gate JSON to clipboard">Copy gate JSON</button>
            <button class="btn" id="gatePaste" title="Paste/import gate JSON">Paste gate JSON</button>
          </div>
          <div class="note" style="margin-top:8px">Operands are condition labels: A, B, C… Operators: AND, OR, NOT, parentheses.</div>
        </div>

        <div class="card" id="details">
          <div class="sectionTitle">Selected cell</div>
          <div class="note" id="emptySel">Click a cell to inspect its expression profile. Use gene search to paint expression across the tissue.</div>
          <div id="sel" style="display:none">
            <div class="kv">
              <div class="k">Cell ID</div><div class="v" id="selId"></div>
              <div class="k">Type</div><div class="v" id="selType"></div>
              <div class="k">Coordinates</div><div class="v" id="selXY"></div>
              <div class="k">Neighborhood</div><div class="v" id="selZone"></div>
            </div>
            <div class="bars" id="bars"></div>
            <div class="note" style="margin-top:10px">
              Values are synthetic “log-normalized” expression (higher ≈ more transcripts). Marker genes are enriched by cell type (e.g., CD3D/E in T cells, COL1A1 in fibroblasts).
            </div>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">How to use</div>
          <div class="note">
            • Pan: drag • Zoom: mouse wheel / trackpad • Tap: select cell<br/>
            • Filters: hide/show cell types • Gene query: colors cells by expression
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
